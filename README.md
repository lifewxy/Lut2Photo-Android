# Lut2Photo Android应用版本

一个功能强大的Android LUT图片处理应用，支持批量处理、实时文件夹监控、GPU加速和丰富的水印功能。

![应用版本](https://img.shields.io/badge/版本-2.5-blue)
![Android](https://img.shields.io/badge/Android-12+-green)
![Kotlin](https://img.shields.io/badge/Kotlin-1.8.0-purple)
![Material 3](https://img.shields.io/badge/Material%203-支持-orange)

## 📖 目录
- [使用指南](#使用指南)
- [主要特性](#主要特性)
- [技术架构](#技术架构)
- [核心功能详解](#核心功能详解)
  - [LUT处理引擎](#lut处理引擎)
  - [水印系统](#水印系统)
  - [批量处理与文件夹监控](#批量处理与文件夹监控)
- [设置详解](#设置详解)
  - [处理器设置](#处理器设置)
  - [处理参数](#处理参数)
  - [水印配置](#水印配置)
  - [文件夹监控设置](#文件夹监控设置)
- [技术细节](#技术细节)
- [注意事项](#注意事项)
- [使用场景](#使用场景)

------------

## 📚 使用指南

### 快速开始

#### 1. 初始设置
1. **下载安装**应用
2. **授予权限**：
   - 存储权限（必需）
   - 通知权限（推荐）
   - 后台运行权限（文件夹监控必需）
3. **关闭电池优化**（文件夹监控必需）

#### 2. 单次批量处理
1. 进入**手动处理**页面
2. 点击**选择图片**，从相册选择要处理的图片
3. 点击**选择LUT**，选择要应用的LUT文件
4. 点击**选择输出文件夹**，设置保存位置
5. 调节**处理参数**（可选）
6. 设置**水印**（可选）
7. 点击**开始处理**

#### 3. 文件夹监控设置
1. 进入**文件夹监控**页面
2. 设置**输入文件夹**（相机上传文件夹）
3. 设置**输出文件夹**（处理后保存位置）
4. 选择**LUT文件**
5. 调节**处理参数**
6. 设置**水印**（可选）
7. 开启**文件夹监控**开关

### 高级使用技巧

#### LUT文件管理
- **支持格式**：仅支持标准CUBE格式(.cube)
- **存储位置**：建议在内部存储中创建LUT文件夹
- **命名规范**：使用有意义的名称，如`Portrait_Warm.cube`
- **大小限制**：单个LUT文件建议不超过10MB

#### 性能优化建议
1. **处理器选择**：
   - 首次使用先选择AUTO模式
   - 如果设备支持GPU且效果良好，可固定使用GPU模式
   - 老模式设备或遇到问题时使用CPU模式

2. **内存管理**：
   - 大图片（>5000像素）建议优先使用GPU处理
   - 批量处理时避免选择过多图片同时处理
   - 定期清理应用缓存

3. **文件夹监控**：
   - 选择SSD硬盘作为输出目录，提高写入速度
   - 避免监控网络文件夹，可能导致延迟
   - 定期清理输出文件夹的已处理文件


## 🚀 主要特性

### 🎯 核心功能
- **实时文件夹监控**：自动检测新文件并立即处理
- **批量图片处理**：支持同时处理多张图片
- **双引擎处理**：CPU/GPU双重处理引擎，智能回退机制
- **多种抖动算法**：Floyd-Steinberg、随机抖动，有效减少色彩断层
- **可调节效果强度**：0-100%强度调节，支持精细控制
- **高质量输出**：50-100%质量范围，平衡文件大小与画质

### 🎨 水印系统
- **文字水印**：支持EXIF变量替换，自定义字体、颜色、位置
- **图片水印**：支持PNG/JPG水印图片，可调透明度和尺寸
- **边框功能**：四边独立边框控制，0-150%宽度可调
- **高级排版**：行间距、字间距、对齐方式等精细控制

### 🔧 技术特性
- **GPU加速处理**：OpenGL ES 3.0着色器加速，大幅提升处理速度
- **内存优化**：智能图片压缩，防止大图OOM崩溃
- **MVVM架构**：清晰的分层架构，易于维护和扩展
- **Material 3设计**：动态颜色主题，现代化UI
- **无网络权限**：完全离线工作，保护用户隐私

## 🏗️ 技术架构

### 整体架构概览
应用采用MVVM（Model-View-ViewModel）分层架构设计，确保代码清晰分离和高度可维护性：

```
┌─────────────────────────────────────────────────────────────┐
│                        UI Layer (View)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │    Home      │  │  Dashboard   │  │   Settings   │      │
│  │  Fragment    │  │  Fragment    │  │  Fragment    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                   ViewModel Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │    Home      │  │  Dashboard   │  │   Settings   │      │
│  │  ViewModel   │  │  ViewModel   │  │  ViewModel   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                     Core Layer (Model)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │    Thread    │  │   LUT        │  │  Watermark   │      │
│  │   Manager    │  │ Processors   │  │  Processor   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ Preferences  │  │     LUT      │  │   Folder     │      │
│  │   Manager    │  │   Manager    │  │  Monitor     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 核心组件说明

#### 🎯 ThreadManager（线程管理器）
- **职责**：统一管理CPU和GPU处理任务调度
- **特性**：
  - CPU最大5个并发任务
  - GPU串行处理，避免资源竞争
  - 智能处理器选择（AUTO/CPU/GPU）
  - OOM防护机制

#### ⚡ LUT处理引擎
- **CpuLutProcessor**：基于Kotlin的CPU处理实现
- **GpuLutProcessor**：基于OpenGL ES 3.0的GPU加速实现
- **ILutProcessor**：统一接口，支持处理器热切换

#### 🎨 水印处理系统
- **WatermarkProcessor**：Canvas绘制引擎
- **WatermarkConfig**：完整的配置数据模型
- **ExifReader**：EXIF信息读取与变量替换

#### 📁 文件夹监控服务
- **FolderMonitorService**：前台服务，确保后台运行
- **文件完整性校验**：防止处理不完整的文件
- **断点续传机制**：应用重启后继续未完成任务

## 🔧 核心功能详解

### LUT处理引擎

#### GPU处理器（推荐）
**技术实现**：
- 使用OpenGL ES 3.0着色器进行并行计算
- 支持3D LUT纹理查找，精度更高
- 二维分块处理，突破GPU纹理尺寸限制
- 自动回退到CPU处理，确保兼容性

**性能优势**：
```
测试设备：骁龙8e
图片尺寸：4000x6000
GPU处理：~0.8秒
CPU理：~15秒
```


#### CPU处理器（备用）
**技术实现**：
- 纯Kotlin实现，无需外部依赖
- 三线性插值算法，确保色彩过渡平滑
- 多线程并行处理，充分利用CPU核心
- 内存优化，避免大图OOM

### 水印系统

#### **EXIF变量支持**：

| 变量名 | 参数 | 备注 | 示例 |
| :---: | :---: | :---: | :---: |
| `{ISO}` | ISO感光度 |  | 100 |
| `{APERTURE}` | 光圈 |  | 2.8 |
| `{SHUTTER}` | 快门 | 支持分数格式 | 1/125 |
| `{CAMERA_MODEL}` | 相机型号 |  | DC-S1 |
| `{LENS_MODEL}` | 镜头型号 |  | 24-70mm f/2.8 |
| `{DATE}` | 拍摄日期 |  | 2025-01-15 |
| `{TIME}` | 拍摄时间 |  | 14:30:25 |
| `{FOCAL_LENGTH}` | 镜头焦距 |  | 35mm |
| `{EXPOSURE_COMPENSATION}` | 曝光补偿 |  | +0.7 EV |
| `{WHITE_BALANCE}` | 白平衡 |  | 自动 |
| `{FLASH}` | 闪光灯 | 是/否 | 否 |

**高级排版特性**：
- **多行文本**：支持换行
- **对齐方式**：左对齐/居中/右对齐
- **自定义字体**：支持导入TTF/OTF字体文件
- **智能尺寸调节**：根据图片宽度自动调节字体大小
- **精细间距控制**：字间距、行间距可调

#### 图片水印功能
- **支持格式**：PNG（透明）、JPG、WEBP
- **尺寸控制**：基于图片宽度的百分比调节
- **透明度**：0-100%可调，支持半透明叠加

#### 边框功能
- **四边独立控制**：上下左右边框宽度独立设置
- **智能比例**：基于图片短边的百分比计算
- **颜色定制**：支持任意颜色

### 批量处理与文件夹监控

#### 批量处理特性
- **多图片同时选择**：支持从相册一次性选择多张图片
- **进度显示**：实时显示处理进度和剩余时间
- **并行处理**：CPU模式下支持最大5个图片同时处理
- **错误处理**：单个图片失败不影响整体进度

#### 文件夹监控机制
**工作原理**：
1. **实时扫描**：每2秒扫描一次输入文件夹
2. **文件过滤**：仅处理JPG/JPEG/PNG/WEBP格式
3. **完整性校验**：检测文件是否上传完成
4. **去重处理**：防止同一文件被多次处理
5. **断点续传**：应用重启后自动继续未完成任务

**错误恢复**：
- **重试机制**：不完整文件最多重试10次
- **内存管理**：自动释放无用内存，防止内存泄漏
- **电源管理**：获取WakeLock，防止系统休眠中断处理

## ⚙️ 设置详解

### 处理器设置

#### 处理器类型选择
| 选项 | 描述 | 适用场景 | 性能表现 |
| :---: | :---: | :---: | :---: |
| **AUTO**（推荐） | 自动选择最优处理器 | 适合新手用户 | GPU可用时优先使用GPU |
| **GPU** | 强制使用GPU处理 | 高性能需求 | 最快，但部分设备不支持 |
| **CPU** | 强制使用CPU处理 | 兼容性优先 | 较慢，但兼容性最好 |

#### GPU可用性检测
应用会自动检测设备的GPU能力：
- **OpenGL ES 3.0支持**检测
- **3D纹理支持**验证
- **着色器编译**测试
- **内存容量**评估


### 处理参数

#### 效果强度（Strength）
- **范围**：0-100%
- **默认值**：60%
- **作用**：控制LUT效果与原图的混合比例

#### 输出质量（Quality）
- **范围**：50-100%
- **默认值**：90%
- **影响**：输出文件大小和画质

#### 抖动算法（Dithering）
| 算法 | 描述 | 适用场景 | 计算复杂度 |
| :---: | :---: | :---: | :---: |
| **无抖动** | 不使用抖动算法 | 高质量图片，追求速度 | 最低 |
| **Floyd-Steinberg** | 经典错误扩散算法 | 一般性效果，平衡质量和效果 | 高 |
| **随机抖动** | 基于随机噪声的抖动 | 特殊艺术效果 | 低 |

> ⚠️ **注意**：抖动算法主要用于减少色彩断层，对于高质量原图可能效果不明显，触发分块算法会强制应用随机抖动。

### ### 水印配置

#### 基础设置
| 项目 | 说明 | 范围/选项 | 默认值 |
| :---: | :---: | :---: | :---: |
| **水印开关** | 启用/禁用水印功能 | 开/关 | 关 |
| **文字水印** | 启用文字水印 | 开/关 | 开 |
| **图片水印** | 启用图片水印 | 开/关 | 关 |

> 📝 **重要**：文字水印和图片水印可以同时使用，位置和透明度独立控制。

#### 文字水印设置
| 参数 | 说明 | 范围 | 默认值 |
| :---: | :---: | :---: | :---: |
| **文字内容** | 水印文本，支持EXIF变量 | 任意文本 | 拍摄参数：ISO {ISO}... |
| **水平位置** | 水平位置百分比 | 0-100% | 10% |
| **垂直位置** | 垂直位置百分比 | 0-100% | 90% |
| **文字大小** | 相对于图片宽度的百分比 | 5-50% | 10% |
| **透明度** | 文字透明度 | 0-100% | 80% |
| **文字颜色** | 文字颜色（十六进制） | #000000-#FFFFFF | #FFFFFF |
| **对齐方式** | 文字对齐方式 | 左/中/右 | 左对齐 |

#### 高级文字设置
| 参数 | 说明 | 范围 | 默认值 |
| :---: | :---: | :---: | :---: |
| **字体文件** | 自定义字体TTF/OTF文件 | 文件路径 | 系统默认 |
| **字间距** | 字符间隔百分比 | 0-100% | 0% |
| **行间距** | 行与行之间的间距百分比 | 0-100% | 0% |

#### 图片水印设置
| 参数 | 说明 | 范围 | 默认值 |
| :---: | :---: | :---: | :---: |
| **水印图片** | 水印图片文件路径 | PNG/JPG/WEBP | 无 |
| **水平位置** | 水平位置百分比 | 0-100% | 90% |
| **垂直位置** | 垂直位置百分比 | 0-100% | 10% |
| **图片大小** | 相对于图片宽度的百分比 | 5-50% | 10% |
| **透明度** | 图片透明度 | 0-100% | 80% |

#### 边框设置
| 参数 | 说明 | 范围 | 默认值 |
| :---: | :---: | :---: | :---: |
| **上边框** | 上边框宽度百分比 | 0-150% | 0% |
| **下边框** | 下边框宽度百分比 | 0-150% | 0% |
| **左边框** | 左边框宽度百分比 | 0-150% | 0% |
| **右边框** | 右边框宽度百分比 | 0-150% | 0% |
| **边框颜色** | 边框颜色（十六进制） | #000000-#FFFFFF | #000000 |

> 📊 **计算方式**：边框宽度基于图片短边计算，确保不同尺寸图片的边框比例一致。

### 文件夹监控设置

#### 基本配置
| 项目 | 说明 | 注意事项 |
| :---: | :---: | :---: |
| **输入文件夹** | 监控的源文件夹 | 需要读取权限 |
| **输出文件夹** | 处理后的图片保存位置 | 需要写入权限 |
| **LUT文件** | 使用的LUT文件 | 仅支持.cube格式 |
| **监控开关** | 启用/停止文件夹监控 | 开启后后台运行 |

#### 高级选项
- **处理参数**：与批量处理相同的强度、质量、抖动设置
- **水印配置**：可与批量处理独立设置不同的水印参数
- **文件命名**：自动按照`原文件名-LUT名.jpg`格式命名

#### 后台运行保障
为了确保文件夹监控服务稳定运行，应用实现了多重保障机制：

1. **前台服务**：使用Foreground Service确保高优先级
2. **WakeLock**：防止系统休眠中断处理
3. **开机启动**：支持开机自动恢复监控
4. **崩溃恢复**：应用崩溃后自动重启监控
5. **通知提醒**：实时显示监控状态和处理进度



## 🎨 使用场景

### 专业摄影应用

#### 相机制造商支持
- **松下**：一代机无LUT烧录，使用LUMIX Sync边拍边传搭配本应用
- **索尼**：配合Imaging Edge Mobile实现实时LUT处理
- **佳能/尼康**：通过相应应用传输后自动处理


### 日常使用
- **社交媒体**：快速优化照片后发布
- **旅行摄影**：统一处理旅行照片，保持风格一致
- **家庭纪念**：批量处理家庭合影，制作相册
- **学习练习**：理解LUT原理，提升后期技能

## 📡 技术支持

### 技术栈
- **开发语言**：Kotlin
- **框架**：Android Jetpack，Material Design 3
- **架构**：MVVM + Repository Pattern
- **图形处理**：OpenGL ES 3.0，Canvas API
- **并发处理**：Kotlin Coroutines
- **数据存储**：SharedPreferences，DocumentFile API

### 开源信息
本应用基于Python版本LUT处理算法移植开发：
- **Python版项目**：[Lut2Photo-Py](https://github.com/qh7574/Lut2Photo-Py)
- **授权协议**：免费使用，遵循MPL协议

### 贡献与反馈
- **Bug报告**：通过应用内反馈功能或GitHub Issues
- **功能建议**：欢迎在GitHub上提出Feature Request
- **代码贡献**：欢迎提交Pull Request

------------

### 项目贡献
免费使用，如果有帮到你，可以在设置页找到赞助码🍵

**作者**：偷光你的小鱼干（某些情况下也叫狸花饺子喵）

> 💻 *代码水平很烂，感谢AI，能跑就行*

---

🌟 **喜欢这个项目吗？记得给个 Star ⭐**
